<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heckel Diff Validator</title>

  <style>
/* BASE STYLES (Mobile: Stack vertically, Dark Theme equivalent to Tailwind) */
body {
  font-family: sans-serif;
  display: flex;
  flex-direction: column;
  padding: 16px; /* p-4 */
  gap: 16px; /* gap-4 */
  background-color: #1e1e1e; /* bg-gray-900 */
  color: #d4d4d4; /* text-gray-100 */
  height: 100vh;
  margin: 0;
}

.container {
  display: flex;
  flex-direction: column; 
  gap: 16px;
  width: 100%;
  flex: 1;
}

.column {
  display: flex;
  flex-direction: column;
  flex: 1 0 auto;
  min-height: 200px;
}

.input-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px; /* mb-2 */
}

.label-old { color: #60a5fa; } /* text-blue-400 */
.label-new { color: #4ade80; } /* text-green-400 */
.label-result { color: #c084fc; } /* text-purple-400 */

.button {
  padding: 4px 12px; /* px-3 py-1 */
  border-radius: 4px; /* rounded */
  font-size: 12px; /* text-xs */
  cursor: pointer;
  border: none;
  transition: background-color 0.2s;
  color: white;
}

.button-old { background-color: #2563eb; } /* bg-blue-600 */
.button-old:hover { background-color: #1d4ed8; } /* hover:bg-blue-700 */

.button-new { background-color: #16a34a; } /* bg-green-600 */
.button-new:hover { background-color: #15803d; } /* hover:bg-green-700 */

.run-button {
  background-color: #9333ea;
  font-size: 14px;
  padding: 8px 16px;
  margin-top: 10px;
}
.run-button:hover { background-color: #7e22ce; }


textarea {
  flex: 1;
  background-color: #252526; /* bg-gray-800 */
  border: 1px solid #444; /* border-gray-700 */
  border-radius: 6px; /* rounded */
  padding: 12px; /* p-3 */
  font-family: monospace;
  font-size: 14px;
  resize: none;
  color: #d4d4d4;
  outline: none;
  line-height: 1.4;
}

/* DESKTOP STYLES (Media Query equivalent of lg:flex-row) */
@media (min-width: 1024px) {
  .container {
    flex-direction: row; 
  }
  .column {
    flex: 1 1 0%; 
    min-height: 0;
  }
}
  </style>
</head>
<body>

  <div class="container">
    
    <div class="column">
      <div class="input-header">
        <label class="text-sm font-semibold label-old">Original Document (OD)</label>
        <label class="button button-old">
          Upload File A
          <input 
            type="file" 
            id="oldFile"
            onchange="handleFileUpload(event, 'oldText')"
            accept=".txt,.log,.md,text/*"
            class="hidden"
            style="display: none;"
          />
        </label>
      </div>
      <textarea
        id="oldText"
        placeholder="Enter old text or upload a file..."
      >The quick brown fox
jumps over the lazy dog
in the moonlight
with great enthusiasm</textarea>
    </div>

    <div class="column">
      <div class="input-header">
        <label class="text-sm font-semibold label-new">Bigger Document (BD)</label>
        <label class="button button-new">
          Upload File B
          <input 
            type="file" 
            id="newFile"
            onchange="handleFileUpload(event, 'newText')"
            accept=".txt,.log,.md,text/*"
            class="hidden"
            style="display: none;"
          />
        </label>
      </div>
      <textarea
        id="newText"
        placeholder="Enter new text or upload a file..."
      >The quick brown fox
leaps over the lazy dog
in the moonlight
under the stars
with great enthusiasm</textarea>
    </div>

    <div class="column">
      <label class="text-sm font-semibold label-result mb-2">Additions & Deletions (JSON Output)</label>
      <textarea
        id="diffResult"
        readOnly
        placeholder="Diff results (JSON) will appear here..."
      ></textarea>
    </div>

  </div>

  <button class="button run-button" onclick="runDiff()">Run Diff Check</button>

  <script>
function heckelDiff(oldLines, newLines) {
  // Full implementation of Paul Heckel's diff algorithm (corrected)
  
  const OA = oldLines.map((line, i) => ({ line, index: i, symbol: null, entry: null }));
  const NA = newLines.map((line, i) => ({ line, index: i, symbol: null, entry: null }));
  const table = {};

  const initializeEntry = (line) => table[line] = table[line] || { NC: 0, OC: 0, OLNO: null, NLNO: null };

  // Pass 1 & 2: Index files (Combined for brevity)
  NA.forEach((item, i) => {
    const entry = initializeEntry(item.line);
    entry.NC++;
    entry.NLNO = i;
    item.entry = entry;
  });
  OA.forEach((item, i) => {
    const entry = initializeEntry(item.line);
    entry.OC++;
    entry.OLNO = i;
    item.entry = entry;
  });

  // Pass 3: Find unique common lines (NC = OC = 1) -> Anchors
  OA.forEach((item, i) => {
    const entry = item.entry;
    if (entry.NC === 1 && entry.OC === 1) {
      OA[i].symbol = '=';
      NA[entry.NLNO].symbol = '=';
    }
  });

  // Pass 4: Growing matches forward (Corrected: only sets symbol, not entry's OLNO/NLNO)
  for (let i = 0; i < OA.length - 1; i++) {
    if (OA[i].symbol === '=') {
      const j = OA[i].entry.NLNO; 
      if (j < NA.length - 1 && OA[i + 1].symbol === null && NA[j + 1].symbol === null) {
        if (OA[i + 1].line === NA[j + 1].line) {
          OA[i + 1].symbol = '=';
          NA[j + 1].symbol = '=';
        }
      }
    }
  }

  // Pass 5: Growing matches backward (Corrected: only sets symbol)
  for (let i = OA.length - 1; i > 0; i--) {
    if (OA[i].symbol === '=') {
      const j = OA[i].entry.NLNO;
      if (j > 0 && OA[i - 1].symbol === null && NA[j - 1].symbol === null) {
        if (OA[i - 1].line === NA[j - 1].line) {
          OA[i - 1].symbol = '=';
          NA[j - 1].symbol = '=';
        }
      }
    }
  }

  // Pass 6: Detect moved blocks and true deletions/additions

  // Mark all unmatched lines that appear in both files as 'M' (Move/Change Candidate)
  OA.forEach(item => {
    if (item.symbol === null && item.entry.NC > 0) {
      item.symbol = 'M';
    }
  });
  
  NA.forEach(item => {
    if (item.symbol === null && item.entry.OC > 0) {
      item.symbol = 'M';
    }
  });

  // Identify sequences of 'M' lines (blocks)
  const getBlocks = (arr) => {
    const blocks = [];
    let currentBlock = [];
    arr.forEach((item) => {
      if (item.symbol === 'M') {
        currentBlock.push(item);
      } else if (currentBlock.length > 0) {
        blocks.push(currentBlock);
        currentBlock = [];
      }
    });
    if (currentBlock.length > 0) blocks.push(currentBlock);
    return blocks;
  };

  const oldBlocks = getBlocks(OA);
  const newBlocks = getBlocks(NA);
  
  // Match moved blocks
  oldBlocks.forEach(oldBlock => {
    const oldBlockLines = oldBlock.map(item => item.line).join('\n');
    newBlocks.forEach(newBlock => {
      const newBlockLines = newBlock.map(item => item.line).join('\n');
      if (oldBlockLines === newBlockLines && oldBlockLines.length > 0) {
        // Mark as moved '⇄'
        oldBlock.forEach(item => item.symbol = '⇄');
        newBlock.forEach(item => item.symbol = '⇄');
      }
    });
  });

  // Final Pass: Mark true deletions ('-') and additions ('+')
  OA.forEach(item => {
    if (item.symbol === null) {
      item.symbol = '-'; 
    }
  });
  
  NA.forEach(item => {
    if (item.symbol === null) {
      item.symbol = '+';
    }
  });

  return { oldArray: OA, newArray: NA };
}

function runDiff() {
  const oldText = document.getElementById('oldText').value;
  const newText = document.getElementById('newText').value;
  const diffResultArea = document.getElementById('diffResult');

  // Filter out pure whitespace lines (matching original implementation)
  const oldLines = oldText.split('\n').filter(l => l.trim().length > 0);
  const newLines = newText.split('\n').filter(l => l.trim().length > 0);

  if (oldLines.length === 0 && newLines.length === 0) {
    diffResultArea.value = "Error: No content provided in either document.";
    return;
  }

  try {
    const { oldArray, newArray } = heckelDiff(oldLines, newLines);

    const additions = newArray
      .filter(item => item.symbol === '+')
      .map(item => item);
    
    const deletions = oldArray
      .filter(item => item.symbol === '-')
      .map(item => item);
    
    // --- START: CUSTOM OUTPUT FORMATTING (The change is here) ---
    const addedLines = additions.map(item => `+>${item.index + 1}: ${item.line}`);
    const deletedLines = deletions.map(item => `<-${item.index + 1}: ${item.line}`);
    
    const outputList = [
      ...addedLines,
      ...deletedLines,
      `stats: +${additions.length} -${deletions.length}`
    ];

    diffResultArea.value = outputList.join('\n');
    // --- END: CUSTOM OUTPUT FORMATTING ---

  } catch (error) {
    console.error("Diff calculation failed:", error);
    diffResultArea.value = "Error: Diff calculation failed. Check console for details.";
  }
}

function handleFileUpload(event, textareaId) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById(textareaId).value = e.target.result;
      runDiff();
    };
    reader.readAsText(file);
  }
}

// Run on load to show initial results
window.onload = runDiff;
  </script>
</body>
</html>
