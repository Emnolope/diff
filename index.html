<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vanilla JS Heckel Diff</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; gap: 10px; padding: 20px; background-color: #1e1e1e; color: #d4d4d4; }
        .container { display: flex; gap: 10px; width: 100%; height: 80vh; }
        textarea { flex: 1; padding: 10px; border: 1px solid #3a3a3a; background-color: #252526; color: #d4d4d4; font-family: monospace; resize: none; }
        .column { flex: 1; display: flex; flex-direction: column; }
        h3 { color: #569cd6; margin: 0 0 5px 0; }
        #results { background-color: #2d2d30; border: 1px solid #3a3a3a; padding: 10px; overflow-y: scroll; white-space: pre-wrap; font-family: monospace; height: 100%; }
        .deletion { color: #f44747; background-color: #632d2d; }
    </style>
</head>
<body>

    <div class="container">
        <div class="column">
            <h3>Original Document (OD)</h3>
            <textarea id="oldText" placeholder="Paste Old Text Here">The quick brown fox
jumps over the lazy dog
in the moonlight
with great enthusiasm</textarea>
        </div>
        <div class="column">
            <h3>Bigger Document (BD)</h3>
            <textarea id="newText" placeholder="Paste New Text Here">The quick brown fox
leaps over the lazy dog
in the moonlight
under the stars
with great enthusiasm</textarea>
        </div>
        <div class="column">
            <h3>Missing Lines from OD (-)</h3>
            <div id="results">Lines marked in red are missing from the OD.</div>
        </div>
    </div>
    <button onclick="runDiff()">Run Diff Check</button>

    <script>
        // CORE HECKEL DIFF FUNCTION (Corrected and Simplified)
        function heckelDiff(oldLines, newLines) {
            // 1. Initialize arrays and symbol table
            const OA = oldLines.map((line, i) => ({ line, symbol: null, entry: null }));
            const NA = newLines.map((line, i) => ({ line, symbol: null, entry: null }));
            const table = {};

            const initializeEntry = (line) => table[line] = table[line] || { NC: 0, OC: 0, OLNO: null, NLNO: null };

            // Pass 1: Index new file
            NA.forEach((item, i) => {
                const entry = initializeEntry(item.line);
                entry.NC++;
                entry.NLNO = i;
                item.entry = entry;
            });

            // Pass 2: Index old file
            OA.forEach((item, i) => {
                const entry = initializeEntry(item.line);
                entry.OC++;
                entry.OLNO = i;
                item.entry = entry;
            });

            // Pass 3: Find unique common lines (NC = OC = 1) -> Anchors
            OA.forEach((item, i) => {
                const entry = item.entry;
                if (entry.NC === 1 && entry.OC === 1) {
                    OA[i].symbol = '=';
                    NA[entry.NLNO].symbol = '=';
                }
            });

            // Pass 4: Growing matches forward (FIXED: Removed broken line number updates)
            for (let i = 0; i < OA.length - 1; i++) {
                if (OA[i].symbol === '=') {
                    const j = OA[i].entry.NLNO; // Use NLNO from the anchor line's entry
                    if (j < NA.length - 1 && OA[i + 1].symbol === null && NA[j + 1].symbol === null) {
                        if (OA[i + 1].line === NA[j + 1].line) {
                            OA[i + 1].symbol = '=';
                            NA[j + 1].symbol = '=';
                        }
                    }
                }
            }

            // Pass 5: Growing matches backward (FIXED: Removed broken line number updates)
            for (let i = OA.length - 1; i > 0; i--) {
                if (OA[i].symbol === '=') {
                    const j = OA[i].entry.NLNO;
                    if (j > 0 && OA[i - 1].symbol === null && NA[j - 1].symbol === null) {
                        if (OA[i - 1].line === NA[j - 1].line) {
                            OA[i - 1].symbol = '=';
                            NA[j - 1].symbol = '=';
                        }
                    }
                }
            }

            // Pass 6: Final determination of symbols (Crucially, we only care about '-')
            // M, ‚áÑ logic is complex and not needed for a simple 'deletion' check.
            // A line is a TRUE deletion if it has not been marked '=' and has NO occurrences in the new file.
            OA.forEach(item => {
                if (item.symbol === null) {
                    // This is the check you need: is it missing entirely (NC=0)?
                    item.symbol = item.entry.NC === 0 ? '-' : 'M';
                }
            });
            
            NA.forEach(item => {
                if (item.symbol === null) {
                    item.symbol = item.entry.OC === 0 ? '+' : 'M';
                }
            });

            return { oldArray: OA, newArray: NA };
        }

        function runDiff() {
            const oldText = document.getElementById('oldText').value;
            const newText = document.getElementById('newText').value;

            // Remove empty/whitespace lines, as done in the original React code
            const oldLines = oldText.split('\n').filter(l => l.trim().length > 0);
            const newLines = newText.split('\n').filter(l => l.trim().length > 0);

            const { oldArray } = heckelDiff(oldLines, newLines);

            // Filter for only true deletions ('-')
            const deletions = oldArray.filter(item => item.symbol === '-');

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (deletions.length === 0) {
                resultsDiv.innerHTML = `<h3>üéâ SUCCESS: NO MISSING LINES FOUND!</h3><p>Every line in the Original Document was either preserved, moved, or modified (but still detected as present) in the Bigger Document.</p><p>You can proceed with high confidence to **delete the original file**.</p>`;
                resultsDiv.style.backgroundColor = '#2d4d30'; // Greenish background for success
            } else {
                resultsDiv.innerHTML = `<h3>‚ùå FAILURE: ${deletions.length} MISSING LINES FOUND!</h3><p>The following lines from the Original Document were **NOT** found in the Bigger Document and are truly missing data. You **MUST NOT** delete the original file yet.</p>`;
                resultsDiv.style.backgroundColor = '#4d2d30'; // Reddish background for failure
                
                const ul = document.createElement('ul');
                ul.style.listStyleType = 'none';
                ul.style.padding = '0';
                deletions.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'deletion';
                    li.textContent = `(-) ${item.line}`;
                    ul.appendChild(li);
                });
                resultsDiv.appendChild(ul);
            }
        }

        // Run on load to show initial results
        window.onload = runDiff;
    </script>
</body>
</html>
