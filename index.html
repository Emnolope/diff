<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Standalone Heckel Diff Check</title>

  <style>
body {
  font-family: sans-serif;
  display: flex;
  flex-direction: column;
  padding: 20px;
  gap: 15px;
  /* Simple colors resembling the dark theme of the original React code */
  background-color: #1e1e1e;
  color: #d4d4d4;
}

.container {
  display: flex;
  gap: 15px;
  width: 100%;
  min-height: 80vh;
}

.column {
  flex: 1;
  display: flex;
  flex-direction: column;
}

textarea {
  flex: 1;
  padding: 10px;
  border: 1px solid #444;
  background-color: #252526;
  color: #d4d4d4;
  font-family: monospace;
  font-size: 14px;
  resize: none;
}

.result-box {
  background-color: #2d2d30;
  border: 1px solid #444;
  padding: 10px;
  overflow-y: auto;
  min-height: 200px;
  font-family: monospace;
}

/* Status Colors */
.status-ok { color: #50fa7b; }
.status-fail { color: #ff5555; }
  </style>
</head>
<body>

  <div class="container">
    <div class="column">
      <label>Original Document (OD)</label>
      <textarea id="oldText" placeholder="Paste Old Text Here (File A)">The quick brown fox
jumps over the lazy dog
in the moonlight
with great enthusiasm</textarea>
    </div>

    <div class="column">
      <label>Bigger Document (BD)</label>
      <textarea id="newText" placeholder="Paste New Text Here (File B)">The quick brown fox
leaps over the lazy dog
in the moonlight
under the stars
with great enthusiasm</textarea>
    </div>

    <div class="column">
      <label>Deletions Only (Missing Data from OD)</label>
      <div id="results" class="result-box">
        Running diff check...
      </div>
    </div>
  </div>

  <button onclick="runDiff()">Run Diff Check</button>

  <script>
function heckelDiff(oldLines, newLines) {
  // 1. Initialize arrays and symbol table
  const OA = oldLines.map((line, i) => ({ line, symbol: null, entry: null }));
  const NA = newLines.map((line, i) => ({ line, symbol: null, entry: null }));
  const table = {};

  const initializeEntry = (line) => table[line] = table[line] || { NC: 0, OC: 0, OLNO: null, NLNO: null };

  // Pass 1: Index new file
  NA.forEach((item, i) => {
    const entry = initializeEntry(item.line);
    entry.NC++;
    entry.NLNO = i;
    item.entry = entry;
  });

  // Pass 2: Index old file
  OA.forEach((item, i) => {
    const entry = initializeEntry(item.line);
    entry.OC++;
    entry.OLNO = i;
    item.entry = entry;
  });

  // Pass 3: Find unique common lines (NC = OC = 1) -> Anchors
  OA.forEach((item, i) => {
    const entry = item.entry;
    if (entry.NC === 1 && entry.OC === 1) {
      OA[i].symbol = '=';
      NA[entry.NLNO].symbol = '=';
    }
  });

  // Pass 4: Growing matches forward
  for (let i = 0; i < OA.length - 1; i++) {
    if (OA[i].symbol === '=') {
      const j = OA[i].entry.NLNO; // NLNO from the anchor line's entry
      // Check bounds and ensure next lines haven't been matched yet
      if (j < NA.length - 1 && OA[i + 1].symbol === null && NA[j + 1].symbol === null) {
        if (OA[i + 1].line === NA[j + 1].line) {
          OA[i + 1].symbol = '=';
          NA[j + 1].symbol = '=';
          // NO change to OLNO/NLNO in the entry here. This was the bug.
        }
      }
    }
  }

  // Pass 5: Growing matches backward
  for (let i = OA.length - 1; i > 0; i--) {
    if (OA[i].symbol === '=') {
      const j = OA[i].entry.NLNO;
      if (j > 0 && OA[i - 1].symbol === null && NA[j - 1].symbol === null) {
        if (OA[i - 1].line === NA[j - 1].line) {
          OA[i - 1].symbol = '=';
          NA[j - 1].symbol = '=';
        }
      }
    }
  }

  // Pass 6: Final determination
  OA.forEach(item => {
    if (item.symbol === null) {
      // '-' = Deletion (not found in new doc)
      // 'M' = Likely part of a move/change block (found at least once in new doc)
      item.symbol = item.entry.NC === 0 ? '-' : 'M';
    }
  });
  
  NA.forEach(item => {
    if (item.symbol === null) {
      // '+' = Addition (not found in old doc)
      // 'M' = Likely part of a move/change block (found at least once in old doc)
      item.symbol = item.entry.OC === 0 ? '+' : 'M';
    }
  });

  return { oldArray: OA, newArray: NA };
}

function runDiff() {
  const oldText = document.getElementById('oldText').value;
  const newText = document.getElementById('newText').value;
  const resultsDiv = document.getElementById('results');

  // Filter out pure whitespace lines
  const oldLines = oldText.split('\n').filter(l => l.trim().length > 0);
  const newLines = newText.split('\n').filter(l => l.trim().length > 0);

  const { oldArray } = heckelDiff(oldLines, newLines);

  // Focus only on true deletions ('-') from the Original Document
  const deletions = oldArray.filter(item => item.symbol === '-');

  resultsDiv.textContent = ''; // Clear existing content

  if (deletions.length === 0) {
    resultsDiv.className = 'result-box status-ok';
    resultsDiv.innerHTML = `<h3>✅ SUCCESS: NO MISSING DATA FOUND</h3>
<p>All lines from the Original Document were found in the Bigger Document (preserved, moved, or modified). **Deletion is safe.**</p>`;
  } else {
    resultsDiv.className = 'result-box status-fail';
    resultsDiv.innerHTML = `<h3>❌ FAILURE: ${deletions.length} MISSING LINE(S) FOUND</h3>
<p>The following lines from the Original Document were **NOT** detected in the Bigger Document. **DO NOT DELETE** the original yet.</p>
<pre><code>${deletions.map(item => `(-) ${item.line}`).join('\n')}</code></pre>`;
  }
}

// Run on load to show initial results
window.onload = runDiff;
  </script>
</body>
</html>
